---
title: "Simulation Using Weibull Distribution to Evaluate Kaplan Meier Performance"
output: html_notebook
---

## Goal

Analyze the statistical power of continuous Cox regression
and log-rank test (Kaplan Meier analysis) for a single continuous
covariate using simulation data.

```{r}
library(tidyr)
library(ggplot2)
library(survminer)
library(survival)
library(simsurv)
library(dplyr)
```

## Simulation Functions

```{r}
simulate_data <- function(N, maxtime, shape, scale, log_hazard_ratio) {
  covariates <- data.frame(id = 1:N,
                           x = rnorm(N, 0, 1)
                           )
  times <- simsurv(dist = "gompertz",
                   lambdas = shape,
                   gammas = scale,
                   betas = c(x = log_hazard_ratio),
                   x = covariates,
                   maxt = maxtime)
  df <- merge(covariates, times)
  continuous.fit <- coxph(Surv(eventtime, status) ~ x, data=df)
  median.fit <- coxph(Surv(eventtime, status) ~ x > median(x), data=df)
  continuous.pvalue <- coef(summary(continuous.fit))[, 5]
  median.pvalue <- coef(summary(median.fit))[, 5]
  c(linear = continuous.pvalue,
    median = median.pvalue,
    samples = N,
    beta = log_hazard_ratio)
}

simulate_trial <- function(num_simulations, N, maxtime, shape, scale, effect) {
  results <- replicate(num_sims, simulate_data(N, maxtime, 
                                               shape, scale, 
                                               effect))
  data.frame(t(results))
}
```

## Simulate Data

We want to understand how the power of both methods
varies across a variety of experimental settings. 
Varying the sample size ($N$) and effect size ($\beta$)
can inform us if one method is superior to another.

First we set up the simulation conditions across experiments

```{r}
sample_sizes <- c(20, 50, 100, 200, 300, 400, 500)
effect_sizes <- log(c(.7, .8, .9, 1.1, 1.2, 1.3))
design <- expand.grid(N = sample_sizes,
                      logHR = effect_sizes)
num_sims <- 5
mean_survival <- 15 #in months
sd_survival <- 5
maxtime <- 30
shape <- pi / (sqrt(6) * sd_survival)
scale <- shape * exp(-0.5772 - (shape * mean_survival))
```

Next we run all the experiments

```{r}
set.seed(56)
results <- design %>%
  rowwise() %>%
  do(simulate_trial(num_simulations, .$N, maxtime, scale, shape, .$logHR))
```

Finally we compute and plot power statistics

```{r}
power_info <- results %>%
  gather("linear", "median", 
         key="model", value="pvalue") %>%
  group_by(model, samples, beta,) %>%
  summarise(power = sum(pvalue < .05) / n()) %>%
  mutate(HR = paste("HR =", exp(beta)))
power_info
```

## Visualize Results

```{r}
power_info %>%
  mutate(model = case_when(
    model == "linear" ~ "Cox",
    model == "median" ~ "Kaplan Meier"
  )) %>%
  ggplot(aes(samples, power)) +
  geom_point() +
  geom_line(aes(color = model)) +
  facet_wrap(~HR) +
  geom_hline(aes(yintercept = .8), colour = "red", 
             linetype = "dashed") +
  labs(x = "Samples", y = "Power") +
  guides(color=guide_legend(title="Method"))
```


```{r}
times <- simsurv(dist = "gompertz",
                   lambdas = scale,
                   gammas = shape,
                   betas = c(x = 1.1),
                   x = data.frame(id = 1:200, x = rnorm(200, 0, 1)),
                   maxt = 30)
```

```{r}
median(times$eventtime)
```

```{r}
ggsurvplot(survfit(Surv(eventtime, status) ~ 1, data=times))
```

